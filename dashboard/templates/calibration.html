{% extends "base.html" %}

{% block title %}Calibration ‚Ä¢ CSTP Dashboard{% endblock %}

{% block content %}
<hgroup>
    <h1>Calibration Dashboard</h1>
    <p>How well-calibrated are your confidence estimates?</p>
</hgroup>

<form method="get" class="grid">
    <select name="window" aria-label="Time window">
        <option value="">All Time</option>
        <option value="30d" {% if window == '30d' %}selected{% endif %}>Last 30 Days</option>
        <option value="60d" {% if window == '60d' %}selected{% endif %}>Last 60 Days</option>
        <option value="90d" {% if window == '90d' %}selected{% endif %}>Last 90 Days</option>
    </select>
    <button type="submit">Apply</button>
</form>

{% if stats %}
{% if stats.period_start and stats.period_end %}
<p><small>Period: {{ stats.period_start }} to {{ stats.period_end }}</small></p>
{% endif %}

<h2>Overall Stats</h2>
<div class="grid">
    <article>
        <header>Total</header>
        <p class="stat-number">{{ stats.total_decisions }}</p>
    </article>
    <article>
        <header>Reviewed</header>
        <p class="stat-number">{{ stats.reviewed_decisions }}</p>
    </article>
    <article>
        <header>Pending</header>
        <p class="stat-number">{{ stats.pending_decisions }}</p>
    </article>
</div>

<div class="grid">
    <article>
        <header>Accuracy</header>
        <p class="stat-number">{{ stats.accuracy_pct }}%</p>
    </article>
    <article>
        <header>Brier Score</header>
        <p class="stat-number">{{ "%.2f"|format(stats.brier_score) }}</p>
    </article>
    <article>
        <header>Calibration</header>
        <p class="stat-number">{{ stats.calibration_icon }} {{ stats.interpretation|replace('_', ' ')|title }}</p>
    </article>
</div>

{% if stats.confidence_stats %}
<h2>Confidence Distribution</h2>
<div class="grid">
    <article>
        <header>Mean</header>
        <p class="stat-number">{{ stats.confidence_stats.mean_pct }}%</p>
    </article>
    <article>
        <header>Std Dev</header>
        <p class="stat-number">{{ "%.2f"|format(stats.confidence_stats.std_dev) }}</p>
    </article>
    <article>
        <header>Range</header>
        <p class="stat-number">{{ (stats.confidence_stats.min_conf * 100)|int }}-{{ (stats.confidence_stats.max_conf * 100)|int }}%</p>
    </article>
</div>

<details>
    <summary>Distribution by Bucket</summary>
    <table>
        <thead>
            <tr>
                <th>Confidence Range</th>
                <th>Count</th>
                <th>Percentage</th>
            </tr>
        </thead>
        <tbody>
            {% for bucket, count in stats.confidence_stats.bucket_counts.items() %}
            <tr>
                <td>{{ bucket }}</td>
                <td>{{ count }}</td>
                <td>{% if stats.confidence_stats.count > 0 %}{{ (count / stats.confidence_stats.count * 100)|round|int }}%{% else %}--{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</details>
{% endif %}

{% if stats.by_category %}
<h2>By Category</h2>
<figure>
    <table>
        <thead>
            <tr>
                <th scope="col">Category</th>
                <th scope="col">Total</th>
                <th scope="col">Reviewed</th>
                <th scope="col">Accuracy</th>
                <th scope="col">Brier</th>
            </tr>
        </thead>
        <tbody>
            {% for cat in stats.by_category %}
            <tr>
                <td><kbd>{{ cat.category }}</kbd></td>
                <td>{{ cat.total }}</td>
                <td>{{ cat.reviewed }}</td>
                <td>{% if cat.reviewed > 0 %}{{ cat.accuracy_pct }}%{% else %}--{% endif %}</td>
                <td>{% if cat.reviewed > 0 %}{{ "%.2f"|format(cat.brier_score) }}{% else %}--{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</figure>
{% endif %}

{% if stats.recommendations %}
<h2>Recommendations</h2>
<article>
    <ul>
        {% for rec in stats.recommendations %}
        <li>üí° {{ rec }}</li>
        {% endfor %}
    </ul>
</article>
{% endif %}

{% if drift %}
<h2>Drift Analysis</h2>
{% if drift.driftDetected %}
<article class="drift-warning">
    <header>‚ö†Ô∏è Calibration Drift Detected</header>
    <p>Recent performance (30d) differs from historical baseline (90d+).</p>
    
    {% if drift.alerts %}
    <ul>
        {% for alert in drift.alerts %}
        <li class="drift-alert-{{ alert.severity }}">
            <strong>{{ alert.type | replace('_', ' ') | title }}:</strong> {{ alert.message }}
        </li>
        {% endfor %}
    </ul>
    {% endif %}
    
    {% if drift.recent and drift.historical %}
    <details>
        <summary>Details</summary>
        <table>
            <thead>
                <tr>
                    <th>Period</th>
                    <th>Decisions</th>
                    <th>Accuracy</th>
                    <th>Brier</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Recent ({{ drift.recent.window }})</td>
                    <td>{{ drift.recent.decisions }}</td>
                    <td>{{ (drift.recent.accuracy * 100) | round | int }}%</td>
                    <td>{{ "%.2f" | format(drift.recent.brierScore) }}</td>
                </tr>
                <tr>
                    <td>Historical ({{ drift.historical.window }})</td>
                    <td>{{ drift.historical.decisions }}</td>
                    <td>{{ (drift.historical.accuracy * 100) | round | int }}%</td>
                    <td>{{ "%.2f" | format(drift.historical.brierScore) }}</td>
                </tr>
            </tbody>
        </table>
    </details>
    {% endif %}
</article>
{% else %}
<article>
    <p>‚úÖ No drift detected. Recent calibration is consistent with historical baseline.</p>
    {% if drift.recommendations %}
    <ul>
        {% for rec in drift.recommendations %}
        <li>‚ÑπÔ∏è {{ rec.message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
</article>
{% endif %}
{% endif %}

{% else %}
<article>
    <p>Unable to load calibration data.</p>
</article>
{% endif %}
{% endblock %}
