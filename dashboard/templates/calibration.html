{% extends "base.html" %}

{% block title %}Calibration - CSTP Dashboard{% endblock %}

{% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
{% endblock %}

{% block header %}
<div class="page-header">
    <div class="page-header-row">
        <div>
            <h1 class="page-title">Calibration</h1>
            <p class="page-subtitle">How well-calibrated are your confidence estimates?</p>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Time Window Filter -->
<form method="get" class="mb-6">
    <div class="form-row">
        <div class="form-group" style="margin-bottom:0">
            <select name="window" class="form-select" aria-label="Time window">
                <option value="">All Time</option>
                <option value="30d" {% if window == '30d' %}selected{% endif %}>Last 30 Days</option>
                <option value="60d" {% if window == '60d' %}selected{% endif %}>Last 60 Days</option>
                <option value="90d" {% if window == '90d' %}selected{% endif %}>Last 90 Days</option>
            </select>
        </div>
        <div style="flex:0">
            <button type="submit" class="btn btn--primary">Apply</button>
        </div>
    </div>
</form>

{% if stats %}
{% if stats.period_start and stats.period_end %}
<p class="text-sm text-muted mb-4">Period: {{ stats.period_start }} to {{ stats.period_end }}</p>
{% endif %}

<!-- Stat Cards -->
<div class="stat-grid">
    <div class="stat-card">
        <div class="stat-label">Total Decisions</div>
        <div class="stat-value stat-value--accent">{{ stats.total_decisions }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Reviewed</div>
        <div class="stat-value stat-value--success">{{ stats.reviewed_decisions }}</div>
        <div class="stat-detail">{{ stats.pending_decisions }} pending</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Accuracy</div>
        <div class="stat-value {% if stats.accuracy >= 0.9 %}stat-value--success{% elif stats.accuracy >= 0.7 %}stat-value--warning{% else %}stat-value--danger{% endif %}">{{ stats.accuracy_pct }}%</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Brier Score</div>
        <div class="stat-value {% if stats.brier_score <= 0.05 %}stat-value--success{% elif stats.brier_score <= 0.15 %}stat-value--warning{% else %}stat-value--danger{% endif %}">{{ "%.3f"|format(stats.brier_score) }}</div>
        <div class="stat-detail">Lower is better</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Calibration</div>
        <div class="stat-value stat-value--sm">{{ stats.calibration_icon }}</div>
        <div class="stat-detail">{{ stats.interpretation|replace('_', ' ')|title }}</div>
    </div>
</div>

<!-- Charts Row -->
<div class="chart-row">
    <!-- Calibration Plot (Expected vs Actual) -->
    {% if stats.calibration_buckets %}
    <div class="card mb-6" style="flex: 1">
        <div class="card-header">
            <h2 class="card-title" style="margin:0">Calibration Plot</h2>
            <span class="text-muted text-sm">Expected vs Actual success rate</span>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="calibrationChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Confidence Distribution -->
    {% if stats.confidence_stats %}
    <div class="card mb-6" style="flex: 1">
        <div class="card-header">
            <h2 class="card-title" style="margin:0">Confidence Distribution</h2>
            <span class="text-muted text-sm">Mean: {{ stats.confidence_stats.mean_pct }}% | StdDev: {{ "%.3f"|format(stats.confidence_stats.std_dev) }}</span>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="distributionChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Bucket Details Table -->
{% if stats.calibration_buckets %}
<div class="card mb-6">
    <div class="card-header">
        <h2 class="card-title" style="margin:0">Calibration by Bucket</h2>
    </div>
    <div class="card-body" style="padding:0">
        <div class="table-wrapper" style="border:0; border-radius:0">
            <table>
                <thead>
                    <tr>
                        <th>Bucket</th>
                        <th>Decisions</th>
                        <th>Actual Success</th>
                        <th>Expected</th>
                        <th>Gap</th>
                        <th>Assessment</th>
                    </tr>
                </thead>
                <tbody>
                    {% for b in stats.calibration_buckets %}
                    <tr>
                        <td><span class="badge badge--neutral">{{ b.bucket }}</span></td>
                        <td>{{ b.decisions }}</td>
                        <td>{{ (b.success_rate * 100)|round|int }}%</td>
                        <td>{{ (b.expected_rate * 100)|round|int }}%</td>
                        <td>
                            <span class="{% if b.gap|abs <= 0.05 %}text-success{% elif b.gap|abs <= 0.15 %}text-warning{% else %}text-danger{% endif %}">
                                {{ "%+.1f"|format(b.gap * 100) }}%
                            </span>
                        </td>
                        <td>
                            {% if b.interpretation == 'well_calibrated' %}
                            <span class="badge badge--success">Well Calibrated</span>
                            {% elif b.interpretation == 'underconfident' %}
                            <span class="badge badge--info">Underconfident</span>
                            {% elif b.interpretation == 'overconfident' %}
                            <span class="badge badge--danger">Overconfident</span>
                            {% else %}
                            <span class="badge badge--neutral">{{ b.interpretation|replace('_', ' ')|title }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Recommendations -->
{% if stats.recommendations %}
<div class="card mb-6">
    <div class="card-header">
        <h2 class="card-title" style="margin:0">Recommendations</h2>
    </div>
    <div class="card-body">
        <ul class="reason-list">
            {% for rec in stats.recommendations %}
            <li class="reason-item">
                <span class="reason-type" style="color: var(--c-warning)">üí°</span>
                <span class="reason-text">{{ rec }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endif %}

<!-- Drift Analysis -->
{% if drift %}
{% if drift.driftDetected %}
<div class="drift-warning">
    <h3>‚ö†Ô∏è Calibration Drift Detected</h3>
    <p class="text-sm" style="color: var(--c-text-secondary)">Recent performance differs from historical baseline.</p>

    {% if drift.alerts %}
    <ul class="reason-list mt-4">
        {% for alert in drift.alerts %}
        <li class="reason-item">
            <span class="reason-type" style="color: var(--c-warning)">{{ alert.type|replace('_', ' ')|title }}</span>
            <span class="reason-text">{{ alert.message }}</span>
        </li>
        {% endfor %}
    </ul>
    {% endif %}

    {% if drift.recent and drift.historical %}
    <details class="mt-4">
        <summary>Comparison Details</summary>
        <div class="table-wrapper" style="margin-top: var(--sp-3)">
            <table>
                <thead>
                    <tr>
                        <th>Period</th>
                        <th>Decisions</th>
                        <th>Accuracy</th>
                        <th>Brier</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Recent ({{ drift.recent.window }})</td>
                        <td>{{ drift.recent.decisions }}</td>
                        <td>{{ (drift.recent.accuracy * 100)|round|int }}%</td>
                        <td>{{ "%.3f"|format(drift.recent.brierScore) }}</td>
                    </tr>
                    <tr>
                        <td>Historical ({{ drift.historical.window }})</td>
                        <td>{{ drift.historical.decisions }}</td>
                        <td>{{ (drift.historical.accuracy * 100)|round|int }}%</td>
                        <td>{{ "%.3f"|format(drift.historical.brierScore) }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </details>
    {% endif %}
</div>
{% else %}
<div class="card mb-6">
    <div class="card-header">
        <h2 class="card-title" style="margin:0">Drift Analysis</h2>
    </div>
    <div class="card-body">
        <p style="margin:0; color: var(--c-success)">‚úÖ No drift detected. Recent calibration is consistent with historical baseline.</p>
        {% if drift.recommendations %}
        <ul class="reason-list mt-4">
            {% for rec in drift.recommendations %}
            <li class="reason-item">
                <span class="reason-type" style="color: var(--c-info)">‚ÑπÔ∏è</span>
                <span class="reason-text">{{ rec.message }}</span>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
</div>
{% endif %}
{% endif %}

<!-- Chart.js Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const gridColor = 'rgba(46, 51, 72, 0.6)';
    const textColor = '#9498b0';

    Chart.defaults.color = textColor;
    Chart.defaults.borderColor = gridColor;
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.font.size = 12;

    {% if stats.calibration_buckets %}
    // --- Calibration Plot ---
    const calCtx = document.getElementById('calibrationChart');
    if (calCtx) {
        const bucketLabels = [{% for b in stats.calibration_buckets %}{{ b.bucket|tojson }}{% if not loop.last %}, {% endif %}{% endfor %}];
        const actualRates = [{% for b in stats.calibration_buckets %}{{ (b.success_rate * 100)|round(1) }}{% if not loop.last %}, {% endif %}{% endfor %}];
        const expectedRates = [{% for b in stats.calibration_buckets %}{{ (b.expected_rate * 100)|round(1) }}{% if not loop.last %}, {% endif %}{% endfor %}];
        const bucketCounts = [{% for b in stats.calibration_buckets %}{{ b.decisions }}{% if not loop.last %}, {% endif %}{% endfor %}];

        new Chart(calCtx, {
            type: 'bar',
            data: {
                labels: bucketLabels,
                datasets: [
                    {
                        label: 'Actual Success %',
                        data: actualRates,
                        backgroundColor: 'rgba(108, 138, 255, 0.7)',
                        borderColor: '#6c8aff',
                        borderWidth: 1,
                        borderRadius: 4,
                    },
                    {
                        label: 'Expected %',
                        data: expectedRates,
                        backgroundColor: 'rgba(148, 152, 176, 0.3)',
                        borderColor: '#9498b0',
                        borderWidth: 1,
                        borderRadius: 4,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterLabel: function(ctx) {
                                return 'n=' + bucketCounts[ctx.dataIndex];
                            }
                        }
                    },
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 12, padding: 16 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 105,
                        title: { display: true, text: 'Success Rate %' },
                        grid: { color: gridColor }
                    },
                    x: {
                        title: { display: true, text: 'Confidence Bucket' },
                        grid: { display: false }
                    }
                }
            }
        });
    }
    {% endif %}

    {% if stats.confidence_stats %}
    // --- Confidence Distribution ---
    const distCtx = document.getElementById('distributionChart');
    if (distCtx) {
        const distLabels = [{% for bucket, count in stats.confidence_stats.bucket_counts.items() %}{{ bucket|tojson }}{% if not loop.last %}, {% endif %}{% endfor %}];
        const distCounts = [{% for bucket, count in stats.confidence_stats.bucket_counts.items() %}{{ count }}{% if not loop.last %}, {% endif %}{% endfor %}];

        // Color based on count density
        const maxCount = Math.max(...distCounts);
        const distColors = distCounts.map(c => {
            const intensity = 0.3 + (c / maxCount) * 0.7;
            return `rgba(108, 138, 255, ${intensity})`;
        });

        new Chart(distCtx, {
            type: 'bar',
            data: {
                labels: distLabels,
                datasets: [{
                    label: 'Decisions',
                    data: distCounts,
                    backgroundColor: distColors,
                    borderColor: '#6c8aff',
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(ctx) {
                                const total = distCounts.reduce((a, b) => a + b, 0);
                                const pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(0) : 0;
                                return pct + '% of total';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Count' },
                        grid: { color: gridColor }
                    },
                    x: {
                        title: { display: true, text: 'Confidence Range' },
                        grid: { display: false }
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>

{% else %}
<div class="empty-state">
    <div class="empty-state-icon">üìä</div>
    <p class="empty-state-text">Unable to load calibration data.</p>
</div>
{% endif %}
{% endblock %}
