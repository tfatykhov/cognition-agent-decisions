{% extends "base.html" %}

{% block title %}Overview - CSTP Dashboard{% endblock %}

{% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>
// Auto-detect browser timezone and store as cookie
(function() {
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    if (tz && document.cookie.indexOf('tz=' + tz) === -1) {
        document.cookie = 'tz=' + tz + ';path=/;max-age=31536000;SameSite=Lax';
        // Reload on first visit to apply correct timezone
        if (document.cookie.indexOf('tz=') === -1 || document.cookie.indexOf('tz=' + tz) !== -1) {
            const url = new URL(window.location);
            if (!url.searchParams.has('tz')) {
                window.location.reload();
            }
        }
    }
})();
</script>
{% endblock %}

{% block header %}
<div class="page-header">
    <div class="page-header-row">
        <div>
            <h1 class="page-title">Dashboard</h1>
            <p class="page-subtitle">Decision intelligence at a glance</p>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Date Filter Bar -->
<div class="card mb-6">
    <div class="card-body" style="padding: var(--sp-3) var(--sp-4)">
        <div class="date-filter-bar">
            <div class="date-filter-presets">
                <a href="{{ url_for('index', period='today') }}"
                   class="btn btn--sm {% if period == 'today' %}btn--primary{% else %}btn--ghost{% endif %}">Today</a>
                <a href="{{ url_for('index', period='week') }}"
                   class="btn btn--sm {% if period == 'week' %}btn--primary{% else %}btn--ghost{% endif %}">This Week</a>
                <a href="{{ url_for('index', period='month') }}"
                   class="btn btn--sm {% if period == 'month' %}btn--primary{% else %}btn--ghost{% endif %}">This Month</a>
                <a href="{{ url_for('index', period='all') }}"
                   class="btn btn--sm {% if period == 'all' %}btn--primary{% else %}btn--ghost{% endif %}">All Time</a>
            </div>
            <div class="date-filter-custom">
                <form method="get" action="{{ url_for('index') }}" style="display: flex; align-items: center; gap: var(--sp-2)">
                    <input type="hidden" name="period" value="custom">
                    <input type="date" name="date" value="{{ custom_date }}"
                           max="{{ today_str }}"
                           class="input input--sm"
                           onchange="this.form.submit()">
                </form>
                <span class="text-muted text-sm" style="margin-left: var(--sp-2)">{{ tz_name.split('/')[-1] | replace('_', ' ') }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Top-Level Stats -->
<div class="stat-grid">
    <div class="stat-card">
        <div class="stat-label">Decisions</div>
        <div class="stat-value stat-value--accent">{{ total }}</div>
        {% if period != 'all' %}
        <div class="stat-detail">of {{ total_all }} total</div>
        {% endif %}
    </div>
    {% if stats %}
    <div class="stat-card">
        <div class="stat-label">Reviewed</div>
        <div class="stat-value stat-value--success">{{ stats.reviewed_decisions }}</div>
        <div class="stat-detail">{{ stats.pending_decisions }} pending</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Accuracy</div>
        <div class="stat-value {% if stats.accuracy >= 0.9 %}stat-value--success{% elif stats.accuracy >= 0.7 %}stat-value--warning{% else %}stat-value--danger{% endif %}">{{ stats.accuracy_pct }}%</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Brier Score</div>
        <div class="stat-value {% if stats.brier_score <= 0.05 %}stat-value--success{% elif stats.brier_score <= 0.15 %}stat-value--warning{% else %}stat-value--danger{% endif %}">{{ "%.3f"|format(stats.brier_score) }}</div>
        <div class="stat-detail">Lower is better</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Calibration</div>
        <div class="stat-value stat-value--sm">{{ stats.calibration_icon }}</div>
        <div class="stat-detail">{{ stats.interpretation|replace('_', ' ')|title }}</div>
    </div>
    {% endif %}
</div>

{% if total > 0 %}
<!-- Charts Row (2 charts: Category + Outcomes) -->
<div class="chart-row">
    <!-- Category Breakdown (Doughnut) -->
    <div class="card mb-6" style="flex: 1">
        <div class="card-header">
            <h2 class="card-title" style="margin:0">By Category</h2>
        </div>
        <div class="card-body">
            <div class="chart-container chart-container--sm">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Outcome Breakdown (Doughnut) -->
    <div class="card mb-6" style="flex: 1">
        <div class="card-header">
            <h2 class="card-title" style="margin:0">Outcomes</h2>
        </div>
        <div class="card-body">
            <div class="chart-container chart-container--sm">
                <canvas id="outcomeChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tag Cloud + Stakes -->
<div class="detail-row">
    <!-- Tag Cloud -->
    {% if top_tags %}
    <div class="card mb-6" style="flex: 1">
        <div class="card-header">
            <h2 class="card-title" style="margin:0">Top Tags</h2>
            <span class="text-muted text-sm">Most used</span>
        </div>
        <div class="card-body">
            <div class="tag-cloud">
                {% for tag, count in top_tags %}
                <a href="{{ url_for('decisions', search=tag) }}" class="tag-cloud-item tag-cloud-item--size-{{ [1, ((count / top_tags[0][1] * 3)|round|int)]|max }}">
                    {{ tag }}
                    <span class="tag-cloud-count">{{ count }}</span>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Stakes Breakdown -->
    <div class="card mb-6" style="flex: 1">
        <div class="card-header">
            <h2 class="card-title" style="margin:0">By Stakes</h2>
        </div>
        <div class="card-body">
            {% for level in ['critical', 'high', 'medium', 'low'] %}
            {% if stakes_counts.get(level, 0) > 0 %}
            <div class="overview-bar-row">
                <span class="overview-bar-label"><span class="badge badge--stakes-{{ level }}">{{ level }}</span></span>
                <div class="overview-bar-track">
                    <div class="overview-bar-fill overview-bar-fill--{{ level }}" style="width: {{ (stakes_counts[level] / total * 100)|round|int }}%"></div>
                </div>
                <span class="overview-bar-count">{{ stakes_counts[level] }}</span>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
{% else %}
<!-- Empty State -->
<div class="card mb-6">
    <div class="card-body" style="text-align: center; padding: var(--sp-8)">
        <p class="text-muted" style="font-size: 1.125rem; margin-bottom: var(--sp-2)">No decisions for this period</p>
        <p class="text-muted text-sm">Try a different date range or view <a href="{{ url_for('index', period='all') }}">all time</a></p>
    </div>
</div>
{% endif %}

<!-- Decisions List -->
<div class="card mb-6">
    <div class="card-header">
        <h2 class="card-title" style="margin:0">
            {% if period == 'today' %}Today's Decisions
            {% elif period == 'week' %}This Week's Decisions
            {% elif period == 'month' %}This Month's Decisions
            {% elif period == 'custom' %}Decisions for {{ custom_date }}
            {% else %}All Decisions
            {% endif %}
        </h2>
        {% if period != 'all' %}
        <a href="{{ url_for('decisions') }}" class="btn btn--ghost btn--sm">View All</a>
        {% endif %}
    </div>
    <div class="card-body" style="padding: 0">
        {% if decisions_list %}
        {% for d in decisions_list %}
        <a href="{{ url_for('decision_detail', decision_id=d.id[:8]) }}" class="related-card">
            <div class="related-card-main">
                <code class="related-card-id">{{ d.id[:8] }}</code>
                <span class="badge badge--category" style="font-size: 0.5625rem">{{ d.category }}</span>
                <span class="badge badge--stakes-{{ d.stakes }}" style="font-size: 0.5625rem">{{ d.stakes }}</span>
                <span class="related-card-summary">{{ d.summary[:80] }}{% if d.summary|length > 80 %}...{% endif %}</span>
            </div>
            <div style="display: flex; align-items: center; gap: var(--sp-2); flex-shrink: 0">
                {% if d.quality and d.quality.score is not none %}
                <span class="text-muted" style="font-size: 0.6875rem">{{ (d.quality.score * 100)|round|int }}%</span>
                {% endif %}
                <span class="text-muted" style="font-size: 0.6875rem">{{ d.created_at.strftime('%b %d %H:%M') }}</span>
                <span>{{ d.outcome_icon }}</span>
            </div>
        </a>
        {% endfor %}
        {% else %}
        <div style="text-align: center; padding: var(--sp-6); color: var(--c-text-muted)">
            No decisions found for this period
        </div>
        {% endif %}
    </div>
</div>

{% if total > 0 %}
<!-- Charts Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const gridColor = 'rgba(46, 51, 72, 0.6)';
    const textColor = '#9498b0';

    Chart.defaults.color = textColor;
    Chart.defaults.borderColor = gridColor;
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.font.size = 12;

    const palette = ['#6c8aff', '#a78bfa', '#34d399', '#fbbf24', '#f87171', '#38bdf8', '#fb923c', '#f472b6'];

    // --- Category Doughnut ---
    const catCtx = document.getElementById('categoryChart');
    if (catCtx) {
        const catLabels = [{% for k, v in cat_counts.items() %}{{ k|tojson }}{% if not loop.last %}, {% endif %}{% endfor %}];
        const catValues = [{% for k, v in cat_counts.items() %}{{ v }}{% if not loop.last %}, {% endif %}{% endfor %}];

        new Chart(catCtx, {
            type: 'doughnut',
            data: {
                labels: catLabels,
                datasets: [{
                    data: catValues,
                    backgroundColor: palette.slice(0, catLabels.length),
                    borderColor: '#151825',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 10, padding: 12 }
                    }
                }
            }
        });
    }

    // --- Outcome Doughnut ---
    const outCtx = document.getElementById('outcomeChart');
    if (outCtx) {
        const outLabels = [{% for k, v in outcome_counts.items() %}{{ k|tojson }}{% if not loop.last %}, {% endif %}{% endfor %}];
        const outValues = [{% for k, v in outcome_counts.items() %}{{ v }}{% if not loop.last %}, {% endif %}{% endfor %}];
        const outcomeColors = {
            'success': '#34d399',
            'partial': '#fbbf24',
            'failure': '#f87171',
            'pending': '#4a4f6a',
            'abandoned': '#9498b0',
            'reviewed': '#34d399',
        };
        const outColors = outLabels.map(l => outcomeColors[l] || '#6c8aff');

        new Chart(outCtx, {
            type: 'doughnut',
            data: {
                labels: outLabels,
                datasets: [{
                    data: outValues,
                    backgroundColor: outColors,
                    borderColor: '#151825',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 10, padding: 12 }
                    }
                }
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}
